{% extends 'base.html' %}

{% block content %}

{% load chart_extras %}

<div class="py-2" style="display: table; width: 100%; min-height: calc(100vh - 56px - 25px);">
  <div class="align-top pr-2" style="display: table-cell; width: 250px; min-height: 60vh;">
    <div class="mx-auto align-top ow p-2 m-2 bg-white">
      <!-- 검색기능 구현 -->
      <div class="input-group mx-2 border-bottom" style="width: 210px; height: 40px;">
        <label for="input-search" class="sr-only">Search Tree</label>
        <input type="input" class="form-control form-control-sm" id="input-search" placeholder="검색어를 입력하세요." autocomplete="off">
        <div class ="input-group-append">
          <button type="button" class="btn btn-secondary btn-sm mb-2" id="btn-clear-search">초기화</button>
        </div>
      </div>
    
      <!-- 트리창 구역 -->
      <div class="overflow-auto bg-white mx-2" id="data-points-tree" style="width: 210px; height: calc(100vh - 180px); overflow: auto;" ondragstart="dragStart(event)" ondragend="dragEnd(event)">
        <ul>
          {% for building in building_object_list %}
            <li>
              <input class="tree-depth-0" type="checkbox" id="{{ building.pk }}-{{ building.name }}" name="datapoint" value="{{ building.name }}">
              <label for="{{ building.pk }}-{{ building.name }}">
                <span style="vertical-align: middle;">{{ building.name }}</span>
              </label>
              <a><i class="far fa-folder" onclick="showElement()" target-element="{{ building.pk }}-depth-1"></i></a>
            </li>
            <li class="hide transition" id="{{ building.pk }}-depth-1">
              {% for model in model_list %}
                <ul>
                  <li>
                    <input class="tree-depth-1" type="checkbox" id="{{ building.pk }}-{{ building.name }}-{{ model|class_name }}" name="datapoint" value="{{ model|class_name }}">
                    <label for="{{ building.pk }}-{{ building.name }}-{{ model|class_name }}">
                      <span style="vertical-align: middle;">{{ model|class_name }}</span>
                    </label>
                    <a><i class="far fa-folder" onclick="showElement()" target-element="{{ building.pk }}-{{ model|class_name }}-depth-2"></i></a>
                  </li>
                  <li class="hide transition" id="{{ building.pk }}-{{ model|class_name }}-depth-2">
                    <ul>
                    {% for field in model|fields %}
                      <li>
                        <input class="tree-depth-2 endpoint" type="checkbox" id="{{ building.pk }}-{{ building.name }}-{{ model|class_name }}-{{ field }}" name="datapoint" value="{{ field }}">
                        <label for="{{ building.pk }}-{{ building.name }}-{{ model|class_name }}-{{ field }}">
                          <span style="vertical-align: middle;">{{ field }}</span>
                        </label>
                      </li>
                    {% endfor %}
                    </ul>
                  </li>
                </ul>
              {% endfor %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="mx-auto align-top" style="display: table-cell;">
    <div class="row justify-content-between bg-white mx-2 mt-2 p-2">
      <div class="col-9">
        <div class="form-inline">
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm date-button" id="y-sub">-Y</button>
            <button class="btn btn-outline-secondary btn-sm date-button" id="m-sub">-M</button>
            <button class="btn btn-outline-secondary btn-sm date-button" id="d-sub">-D</button>
          </div>
          <div class="input-group input-group-sm ml-2">
            <div class="input-group-prepend">
              <span class="input-group-text">시작일</span>
            </div>
            <input class="form-control datepicker" id="start-day" name="start-day" required type="text" style="width: 120px;">
          </div>
          <div class="input-group input-group-sm ml-2">
            <div class="input-group-prepend">
              <span class="input-group-text">종료일</span>
            </div>
            <input class="form-control datepicker" id="end-day" name="end-day" required type="text" style="width: 120px;">
          </div>
          <div class="btn-group ml-2">
            <button class="btn btn-outline-secondary btn-sm date-button" id="y-add">+Y</button>
            <button class="btn btn-outline-secondary btn-sm date-button" id="m-add">+M</button>
            <button class="btn btn-outline-secondary btn-sm date-button" id="d-add">+D</button>
          </div>
          <div>
            <button type="button" class="btn btn-success btn-sm ml-2" id="chart-reload">업데이트</button>
          </div>
        </div>
      </div>
      <div class="col-3 text-right" style="font-size: 20px;">
        <button type="button" class="btn btn-outline-danger btn-sm" id="sync" data-toggle="button" aria-pressed="false" autocomplete="off" title="차트동기화">
          Sync
        </button>
        <span>&nbsp;&nbsp;</span>
        <a class="btn btn-outline-info btn-sm" href="#" id="addChart" role="button" title="차트추가"><i class="far fa-plus"></i></a>
        <a class="btn btn-outline-info btn-sm" href="#" id="removeChart" role="button" title="차트삭제"><i class="far fa-minus"></i></a>
      </div>
    </div>
    <!-- 차트 구현 -->
    <div class="mx-2 mt-2 bg-white" id="charts_container" style="min-height: calc(100vh - 180px); padding: 10px;">
      <div class="chart-tool text-right" style="height: 20px;">
        <a class="delete-chart ml-2" id="chart-0-delete" href="#" title="닫기" style="visibility: hidden;"><i class="fas fa-times"></i></a>
      </div>
      <div class="chart" id="chart-0" style="height: calc(100vh - 200px - 20px); display: flex; align-items: center; justify-content: center;">
        <a class="draw-chart" id="chart-0-draw" href="#" draggable="false"><i class="fas fa-chart-line fa-5x"></i></a>
      </div>
    </div>
  </div>
</div>

<style>
#data-points-tree ul, li {
  list-style: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-left: 10px;
}

#data-points-tree input, label {
  cursor: pointer;
}

#data-points-tree .hide {
  visibility: hidden;
  max-height: 0;
}

#data-points-tree .show {
  visibility: visible;
  max-height: 999px;
}

#data-points-tree i {
  cursor: pointer;
}


</style>

<script>
  function showElement() {
    var thisEl = event.srcElement;
    var targetId = thisEl.getAttribute('target-element');
    var targetEl = document.getElementById(targetId);
    var hide = targetEl.classList.contains('hide');
    if (hide == true) {
      targetEl.classList.remove('hide');
      targetEl.classList.add('show');
      thisEl.classList.remove('fa-folder');
      thisEl.classList.add('fa-folder-open');
    } else if (hide == false) {
      targetEl.classList.remove('show');
      targetEl.classList.add('hide');
      thisEl.classList.remove('fa-folder-open');
      thisEl.classList.add('fa-folder');
    };
  };

</script>

<!-- 구글차트 구현 -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
  // collapse 클래스 접어놓기
  // collapseChildren();
</script>

<script>
  startDate = '2018-01-01';
  endDate = '2018-01-30';
  pointList = ['23-sam-Ismart-kWh', '23-sam-Ismart-kW_peak', '23-sam-Ismart-kVarh_lag']

  // Load the Visualization API and the corechart package.
  google.charts.load('current', {'packages':['corechart']});

  // Set a callback to run when the Google Visualization API is loaded.
  google.charts.setOnLoadCallback(drawChart);

  // Callback that creates and populates a data table,
  // instantiates the pie chart, passes in the data and
  // draws it.
  function getChartData(startDate, endDate, pointList) {
    var totalJson = {};
    var keys = [];
    for (var i=0; i<pointList.length; i++) {
      jsonUrl = 'http://localhost:8000/chart/google-chart-data/?start-day=' + startDate + '&end-day=' + endDate + '&datapoint=' + pointList[i];
      console.log(jsonUrl);
      json = getjson(jsonUrl);
      totalJson[pointList[i]] = json;
      keys = keys.concat(Object.keys(json['data']));
    };
    var uniqueKeys = Array.from(new Set(keys));

    var chartData = {};
    chartData['cols'] = [{'id': 'timestamp', 'label': 'timestamp', 'type': 'date'}];
    chartData['rows'] = [];
    for (var i=0; i<Object.keys(totalJson).length; i++) {
      buildingKey = Object.keys(totalJson)[i];
      chartData['cols'].push(totalJson[buildingKey]['prop']);
    };

    chartData['rows'] = [];
    for (var i=0; i<uniqueKeys.length; i++) {
      var dateKey = uniqueKeys[i];
      var newRow = {'c': [{'v': dateKey}]}
      for(var j=0; j<Object.keys(totalJson).length; j++) {
        buildingKey = Object.keys(totalJson)[j];
        if (typeof totalJson[buildingKey]['data'][dateKey] != 'undefined') {
          newRow['c'].push({'v': totalJson[buildingKey]['data'][dateKey]});
        } else {
          newRow['c'].push({'v': null});
        };
      };
      chartData['rows'].push(newRow);
    };

    return chartData;
  };

  function drawChart(chartData) {
    // Create the data table.
    var chartData = getChartData(startDate, endDate, pointList);
    var data = new google.visualization.DataTable(chartData);
    console.log(chartData);

    // Set chart options
    var options = {
      'title': 'How Much Pizza I Ate Last Night',
      'width': 1000,
      'height': 800,
      interpolateNulls: true,
      crosshair: {
        trigger: 'both',
        orientation: 'vertical',
      },
    };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
    chart.draw(data, options);
  }



</script>

 
 

{% endblock %}